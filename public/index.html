<html>

<head>
    <title>Multi File Transfer Express</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/stylesheets/style.css">
</head>

<body>
    <div class="jumbotron">
        <div class="container">
            <h1>Multi File Transfer Express</h1>
            <p class="lead">Example...</p>
            <hr class="my-4">

            <form id='file-catcher'>
                <input id='file-input' type='file' class="form-control-file" multiple />
                <div id='files'>
                    <h2>Upload Files</h2>
                    <div id='file-list-display'></div>
                </div>
                <button type='submit' class="btn btn-default">Submit</button>
            </form>
            <hr class="my-4">

            <div id='result'>
                <h2>Result</h2>
                <div id="log" style="word-wrap: break-word"></div>
            </div>
        </div>
    </div>

    <script>
        window.onload = () => {
            let fileCatcher = document.getElementById('file-catcher');
            let fileInput = document.getElementById('file-input');
            let fileListDisplay = document.getElementById('file-list-display');

            let fileList = [];
            let renderFileList, sendFile;

            fileCatcher.addEventListener('submit', async (event) => {
                event.preventDefault();
                await uploadFile(fileList);
                fetchEval();
            });

            fileInput.addEventListener('change', (event) => {
                fileList = [];
                for (let i = 0; i < fileInput.files.length; i++) {
                    fileList.push(fileInput.files[i]);
                }
                renderFileList();
            });

            renderFileList = () => {
                fileListDisplay.innerHTML = '';
                fileList.forEach((file, index) => {
                    let fileDisplayEl = document.createElement('p');
                    fileDisplayEl.innerHTML = (index + 1) + ': ' + file.name;
                    fileListDisplay.appendChild(fileDisplayEl);
                });
            };

            function uploadFile(files) {
                return new Promise((resolve) => {
                    const formData = new FormData();
                    files.forEach(file => formData.append("files", file));

                    const xhr = new XMLHttpRequest();
                    xhr.open("POST", '/workspace/ainized-breast_cancer_classifier/sample_data/images/');
                    xhr.onreadystatechange = () => {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            const data = JSON.parse(xhr.responseText);

                            if (!data["status"]) {
                                sendFile(file);
                            } else {
                                resolve();
                            }
                        }
                    };
                    xhr.send(formData);
                });
            };

            function fetchEval() {
                const xhr = new XMLHttpRequest();
                xhr.open("GET", encodeURI(`/eval`), true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.onreadystatechange = () => {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        document.getElementById("result").style.display = "block";
                        document.getElementById("log").innerText = xhr.responseText;
                    }
                };
                xhr.send(null);
            }
        };
    </script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>

</body>

</html>