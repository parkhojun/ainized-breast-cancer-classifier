<html>

<head>
    <title>Multi File Transfer Express</title>
</head>

<body>
    <form id='file-catcher'>
        <input id='file-input' type='file' multiple />
        <button type='submit'>
            Submit
        </button>
    </form>

    <div id='file-list-display'></div>
    <div id='result'></div>

    <script>
        (function () {
            var fileCatcher = document.getElementById('file-catcher');
            var fileInput = document.getElementById('file-input');
            var fileListDisplay = document.getElementById('file-list-display');

            var fileList = [];
            var renderFileList, sendFile;

            fileCatcher.addEventListener('submit', function (evnt) {
                evnt.preventDefault();
                fileList.forEach(function (file) {
                    sendFile(file);
                });

                eval();
            });

            fileInput.addEventListener('change', function (evnt) {
                fileList = [];
                for (var i = 0; i < fileInput.files.length; i++) {
                    console.log(`Add file ${fileInput.files[i]}`);
                    fileList.push(fileInput.files[i]);
                }
                renderFileList();
            });

            renderFileList = function () {
                fileListDisplay.innerHTML = '';
                fileList.forEach(function (file, index) {
                    var fileDisplayEl = document.createElement('p');
                    fileDisplayEl.innerHTML = (index + 1) + ': ' + file.name;
                    fileListDisplay.appendChild(fileDisplayEl);
                });
            };

            sendFile = function (file) {
                var formData = new FormData();
                var request = new XMLHttpRequest();

                formData.set('file', file);
                request.open("POST", '/upload');
                request.onreadystatechange = () => {
                    if (request.readyState === 4 && request.status === 200) {
                        const data = JSON.parse(request.responseText);
                        console.log(data);

                        if (!data["status"]) {
                            sendFile(file);
                        } else {
                        }
                    }
                };
            };

            eval = () => {
                const xhr = new XMLHttpRequest();
                xhr.open("GET", encodeURI(`/eval`), true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.onreadystatechange = () => {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        console.log(xhr.responseText);
                        document.getElementById("result").textContent = xhr.responseText;
                    }
                };
                xhr.send(null);
            }
        })();
    </script>

</body>

</html>